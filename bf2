-- âœ… **Function Forward Declarations**
local moveTo, saveProgress, loadProgress, placeBlock, buildSchematic, restock, refuelTurtle, findChestAccess

-- âœ… **Restore Disk Startup for Future Turtles**
if peripheral.find("drive") then
    print("ğŸ”„ Restoring disk startup...")
    if fs.exists("/disk/startuptemp.lua") then
        shell.run("mv /disk/startuptemp.lua /disk/startup.lua")
        print("âœ… Disk startup restored.")
    end
end

-- âœ… **Load Progress or Set Default Start Position**
local function loadProgress()
    if fs.exists("progress.txt") then
        local file = fs.open("progress.txt", "r")
        local data = textutils.unserialize(file.readAll())  
        file.close()
        if data and data.index and data.pos then
            print("ğŸ”„ Resuming from saved position:", data.pos.x, data.pos.y, data.pos.z)
            return data.index, data.pos
        end
    end
    return 1, {x = 0, y = 0, z = -5, dir = 0}
end

-- âœ… **Save Progress Function**
local function saveProgress(index, position)
    local file = fs.open("progress.txt", "w")
    file.write(textutils.serialize({index = index, pos = position}))
    file.close()
end

-- âœ… **Stacked Material Chest Positions (-5x, y, 5z)**
local materialChests = {
    ["minecraft:wool"] = {x = -5, y = 1, z = 5, dir = 3},
    ["minecraft:clay"] = {x = -5, y = 2, z = 5, dir = 3},
    ["minecraft:dirt"] = {x = -5, y = 3, z = 5, dir = 3},
    ["minecraft:grass"] = {x = -5, y = 4, z = 5, dir = 3},
    ["minecraft:stone"] = {x = -5, y = 5, z = 5, dir = 3},
    ["minecraft:log"] = {x = -5, y = 6, z = 5, dir = 3}
}
local fuelChest = {x = -5, y = 7, z = 5, dir = 3}

-- âœ… **Set Starting Position**
local buildIndex, pos = loadProgress()

if buildIndex == 1 then
    rednet.open("right")
    local _, turtleID = rednet.receive("turtle_id")
    if not turtleID then return end

    print("âœ… Received Turtle ID:", turtleID)

    -- âœ… **Refuel Once at Startup**
    for i = 1, 16 do
        if turtle.getItemCount(i) > 0 then
            turtle.select(i)
            if turtle.refuel(1) then
                print("â›½ Refueled with 1 Aeternus Fuel Block.")
                break
            end
        end
    end

    -- âœ… **Send Confirmation to Placer Turtle**
    rednet.broadcast("moved", "turtle_status")
    rednet.close("right")

    -- âœ… **Check for Block Data & Download if Needed**
    if not fs.exists("output.lua") then
        print("ğŸŒ Block data not found! Downloading...")
        local dataURL = "https://raw.githubusercontent.com/robertjojo123/limpy3/main/output_" .. turtleID .. ".lua"
        shell.run("wget " .. dataURL .. " output.lua")

        if not fs.exists("output.lua") then
            print("âŒ Failed to download block data. Exiting.")
            return
        end
    end
end

print("ğŸ”„ Loading block data...")
local blocks = dofile("output.lua")

-- âœ… **Find an Open Access Spot for a Chest (Keeps Trying Until It Gets One)**
findChestAccess = function(chestPos)
    local possiblePositions = {
        {x = chestPos.x + 1, z = chestPos.z, dir = 3},
        {x = chestPos.x - 1, z = chestPos.z, dir = 1},
        {x = chestPos.x, z = chestPos.z + 1, dir = 2},
        {x = chestPos.x, z = chestPos.z - 1, dir = 0}
    }

    while true do
        for _, pos in ipairs(possiblePositions) do
            moveTo(pos)
            if not turtle.detect() then
                return pos
            end
            turtle.back()
        end
        print("â³ All spots blocked. Retrying in 2 seconds...")
        sleep(2)
    end
end

-- âœ… **Refuel Function**
refuelTurtle = function()
    print("â›½ Checking fuel level...")
    if turtle.getFuelLevel() >= 1000 then return true end 

    print("ğŸ”„ Finding access point for fuel chest...")
    local accessPoint = findChestAccess(fuelChest)

    print("â›½ Moving to fuel chest at", accessPoint.x, accessPoint.z)
    moveTo(accessPoint)
    while pos.dir ~= accessPoint.dir do turnLeft() end

    while true do
        if turtle.suck(1) then
            turtle.refuel()
            print("âœ… Refueled!")
            return true
        end
        print("â³ Fuel chest empty. Retrying in 2 seconds...")
        sleep(2)
    end
end

-- âœ… **Restock Function**
restock = function(block)
    local blockID = "minecraft:" .. block
    local chestPos = materialChests[blockID]

    if not chestPos then
        print("âŒ No chest found for " .. blockID)
        return false
    end

    print("ğŸ”„ Finding access point for", blockID)
    local accessPoint = findChestAccess(chestPos)

    print("ğŸ”„ Moving to restock", blockID, "at", accessPoint.x, accessPoint.z)
    moveTo(accessPoint)
    while pos.dir ~= accessPoint.dir do turnLeft() end

    while true do
        if turtle.suck(64) then
            print("âœ… Restocked", blockID)
            return true
        end
        print("â³ No items in chest. Retrying in 2 seconds...")
        sleep(2)
    end
end

-- âœ… **Updated Place Block Function**
placeBlock = function(block)
    if not refuelTurtle() then return false end 

    local exists, _ = turtle.inspectDown()
    if exists then
        print("â­ Block already exists, skipping...")
        return true
    end

    for i = 1, 16 do
        local item = turtle.getItemDetail(i)
        if item and item.name == "minecraft:" .. block then
            turtle.select(i)
            if turtle.placeDown() then
                print("âœ… Placed", block)
                return true
            end
        end
    end

    print("âŒ Out of", block, "restocking...")
    if restock(block) then return placeBlock(block) end
    return false
end

-- âœ… **Start Build Process**
buildSchematic = function()
    print("ğŸ— Starting build process...")
    for _, blockData in ipairs(blocks) do
        moveTo(blockData)

        while not placeBlock(blockData[1]) do
            print("ğŸ”„ Retrying placement of " .. blockData[1] .. " after restock")
        end
    end
    print("âœ… Build complete!")
end

buildSchematic()
